Installation manual
===================

RPRP consists of roughly four components.

The server itself runs Ubuntu Server 20.04, and has a /56 associated with it, along with a single IPv6 and IPv4 address that fall outside of that /56 range. A somewhat large IPv6 range is required (although /64 suffices). It must be possible to bind to all these addresses. Pretty much everything is stored inside /var/rpki.

Component 1 is a standard PHP website running behind Apache. No database required. `web/public/index.php` is the main access point. Has a Let's Encrypt certificate for rprp.nlnetlabs.net and *.rprp.nlnetlabs.net. Apache should bind to all interfaces. It uses OpenSSL to generate all certificates and signed objects. It uses `faketime` to make sure those certificates are generated one hour in the past. The PHPASN1 dependency has been slightly edited to increase performance and decrease memory usage - just use the dependencies as-is. `/var/rpki/requests` has directory listing enabled for the subfolders (thus not for `/var/rpki/requests`, but only for `/var/rpki/requests/a` etc.), and is accessible from https://rprp.nlnetlabs.net/data/some-uuid4/ 
```
php
php-bcmath
php-gmp
php-json
php-xml
```

Component 2 is an authoritative PowerDNS server with a custom backend, found in `rsync/dns.py` and `rsync/pdns.conf`. It connects to a SQLite database with one table `rsync` with only one column `host`. If, for example, abc.rprp.nlnetlabs.net is requested, the AAAA record it returns will be the prefix with the row number as suffix. If the address is not yet known, then a new row will be inserted first. This backend requires Python 3.9 (or higher). Lower version do not support the necessary IP address operations.

Component 3 is a modified version of knockd, found in `knockd/knockd` (with config `knockd/knockd.conf`). iptables drops all incoming packets on port 873 (rsync daemon default port). Knockd still receives this packet, and starts the manager
```
# Generated by ip6tables-save v1.8.4 on Wed Aug  4 20:37:44 2021
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [41:4072]
-A INPUT -p tcp -m tcp --dport 873 -j DROP
-A INPUT -p icmp -j ACCEPT
-A INPUT -p tcp -m tcp --dport 53 -j ACCEPT
-A INPUT -p udp -m udp --dport 53 -j ACCEPT
-A INPUT -s 2001:610:1908::/48 -j ACCEPT
-A INPUT -s 2001:67c:2564::/48 -j ACCEPT
-A INPUT -s 2a01:7e01:e002:b900::/56 -j ACCEPT
-A INPUT -s 2a01:7e01::f03c:92ff:fef0:f1c2/128 -j ACCEPT
-A INPUT -s ::1/128 -j ACCEPT
-A INPUT -i eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
COMMIT
```

Component 4 is a manager, found in `rsync/manager.py`, which is called by knockd along with the destination IP address (which identifies the specific test, as we can do a reverse lookup in the SQlite table). This script then copies the files to a temporary directory, starts the rsync daemon with that directory, binds it to the specific interface, and adds an exception for that destination IP address in iptables. That is consequently removed after 5 minutes.

Configuration is largely done in config.php, and in the Python files themselves. 
